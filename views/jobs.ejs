<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./partials/head') %>
    <title>Browse Jobs - Job Portal</title>
    <style>
        .browse-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 20px;
            margin-bottom: 40px;
            border-radius: 20px;
            text-align: center;
        }

        .browse-header h1 {
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .browse-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .filter-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .filter-card h5 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 25px;
            font-size: 18px;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-control, .form-select {
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            padding: 12px 16px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-search {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
            height: 100%;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .jobs-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .job-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border-left: 5px solid #667eea;
        }

        .job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .job-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .job-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
        }

        .job-meta {
            display: flex;
            gap: 25px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }

        .meta-icon {
            color: #667eea;
            font-size: 16px;
        }

        .job-description {
            color: #555;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 14px;
        }

        .job-skills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .skill-badge {
            background: #f0f0f0;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .job-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .salary-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 600;
        }

        .job-actions {
            display: flex;
            gap: 10px;
        }

        .btn-view {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .btn-view:hover {
            background: #f8f9ff;
        }

        .btn-apply {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .btn-apply:hover {
            background: #764ba2;
        }

        .loading-spinner {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner-border {
            color: #667eea;
        }

        .pagination {
            gap: 10px;
        }

        .page-link {
            border-radius: 8px;
            border: 2px solid #e8e8e8;
            color: #667eea;
            font-weight: 600;
        }

        .page-link:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .page-link.active {
            background: #667eea;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .browse-header h1 {
                font-size: 28px;
            }

            .job-header {
                flex-direction: column;
            }

            .job-footer {
                flex-direction: column;
                gap: 15px;
            }

            .job-actions {
                width: 100%;
            }

            .btn-view, .btn-apply {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <%- include('./partials/nav') %>
    
    <div class="container">
        <!-- Header Section -->
        <div class="browse-header">
            <h1>Find Your Dream Job</h1>
            <p>Explore thousands of opportunities from top companies</p>
        </div>

        <!-- SEARCH & FILTER SECTION -->
        <div class="filter-card">
            <h5><i class="bi bi-funnel"></i> Search & Filter</h5>
            <form id="filterForm">
                <div class="row g-3">
                    <!-- Search by Title -->
                    <div class="col-md-4">
                        <label for="search" class="form-label">Job Title</label>
                        <input type="text" class="form-control" id="search" placeholder="e.g., React Developer">
                    </div>

                    <!-- Location Filter -->
                    <div class="col-md-4">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" placeholder="e.g., Mumbai">
                    </div>

                    <!-- Job Type Filter -->
                    <div class="col-md-4">
                        <label for="jobType" class="form-label">Job Type</label>
                        <select class="form-select" id="jobType">
                            <option value="">All Types</option>
                            <option value="Full-time">Full-time</option>
                            <option value="Part-time">Part-time</option>
                            <option value="Contract">Contract</option>
                            <option value="Internship">Internship</option>
                        </select>
                    </div>

                    <!-- Skills Filter -->
                    <div class="col-md-4">
                        <label for="skills" class="form-label">Skills (comma-separated)</label>
                        <input type="text" class="form-control" id="skills" placeholder="e.g., React, Node.js">
                    </div>

                    <!-- Salary Min Filter -->
                    <div class="col-md-3">
                        <label for="salaryMin" class="form-label">Min Salary (LPA)</label>
                        <input type="number" class="form-control" id="salaryMin" placeholder="5">
                    </div>

                    <!-- Salary Max Filter -->
                    <div class="col-md-3">
                        <label for="salaryMax" class="form-label">Max Salary (LPA)</label>
                        <input type="number" class="form-control" id="salaryMax" placeholder="15">
                    </div>

                    <!-- Search Button -->
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn-search">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Jobs Listing Section -->
        <div id="jobsContainer" class="jobs-container">
            <div class="loading-spinner">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <!-- PAGINATION SECTION -->
        <nav aria-label="Job pagination" class="mt-5 mb-5">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination buttons will be added here by JavaScript -->
            </ul>
        </nav>
    </div>
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination buttons will be added here by JavaScript -->
            </ul>
        </nav>
    </div>

    <!-- JOB DETAILS MODAL -->
    <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="jobDetailsContent">
                    <!-- Job details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <% if (locals.user && locals.user.role === 'student') { %>
                        <button type="button" class="btn btn-success" onclick="openApplyModal(currentJobId)">
                            <i class="bi bi-check-circle"></i> Apply Now
                        </button>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <!-- APPLY MODAL -->
    <div class="modal fade" id="applyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Apply for <span id="applyJobTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="applyForm" action="" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="resumeUrl" class="form-label">Resume URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="resumeUrl" name="resumeUrl" required
                                   placeholder="https://example.com/resume.pdf">
                            <div class="form-text">Provide a link to your resume (PDF or document)</div>
                        </div>
                        <div class="mb-3">
                            <label for="coverLetter" class="form-label">Cover Letter</label>
                            <textarea class="form-control" id="coverLetter" name="coverLetter" rows="4"
                                      placeholder="Tell the recruiter why you're a good fit for this role"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Submit Application
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('./partials/script') %>

    <script>
        // Current page state
        let currentPage = 1;
        let currentJobId = null;
        const limit = 10;

        // Load jobs on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadJobs();
        });

        // Check if user is a student
        function isStudentUser() {
            <% if (locals.user && locals.user.role === 'student') { %>
                return true;
            <% } else { %>
                return false;
            <% } %>
        }

        // Handle filter form submission
        document.getElementById('filterForm').addEventListener('submit', (e) => {
            e.preventDefault();
            currentPage = 1; // Reset to page 1 when filtering
            loadJobs();
        });

        // Load jobs function with filters
        async function loadJobs() {
            try {
                // Build query parameters
                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('limit', limit);

                // Add filters if they have values
                const search = document.getElementById('search').value.trim();
                const location = document.getElementById('location').value.trim();
                const skills = document.getElementById('skills').value.trim();
                const jobType = document.getElementById('jobType').value;
                const salaryMin = document.getElementById('salaryMin').value;
                const salaryMax = document.getElementById('salaryMax').value;

                if (search) params.append('search', search);
                if (location) params.append('location', location);
                if (skills) params.append('skills', skills);
                if (jobType) params.append('jobType', jobType);
                if (salaryMin) params.append('salaryMin', salaryMin * 100000);
                if (salaryMax) params.append('salaryMax', salaryMax * 100000);

                // Fetch jobs from API
                const response = await fetch(`/jobs?${params.toString()}`);
                const result = await response.json();

                // Display jobs
                displayJobs(result.data);

                // Display pagination
                displayPagination(result.pagination);

            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('jobsContainer').innerHTML = `
                    <div class="alert alert-danger">Failed to load jobs. Please try again.</div>
                `;
            }
        }

        // Display jobs in cards
        function displayJobs(jobs) {
            const container = document.getElementById('jobsContainer');

            if (!jobs || jobs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">No jobs found. Try different filters.</div>
                `;
                return;
            }

            const jobsHTML = jobs.map(job => `
                <div class="job-card">
                    <div class="job-header">
                        <h3 class="job-title">${job.title}</h3>
                        <span class="job-status status-${job.status === 'Active' ? 'active' : 'closed'}">
                            ${job.status}
                        </span>
                    </div>
                    
                    <div class="job-meta">
                        <div class="meta-item">
                            <i class="bi bi-geo-alt meta-icon"></i>
                            ${job.location}
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-briefcase meta-icon"></i>
                            ${job.jobType}
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-calendar meta-icon"></i>
                            Posted ${new Date(job.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                    
                    <p class="job-description">
                        ${job.description.substring(0, 200)}...
                    </p>
                    
                    <div class="job-skills">
                        ${job.skills.map(skill => `<span class="skill-badge">${skill}</span>`).join('')}
                    </div>
                    
                    <div class="job-footer">
                        <div class="salary-badge">
                            <i class="bi bi-currency-rupee"></i> ${job.salary || 'Not specified'}
                        </div>
                        <div class="job-actions">
                            <button class="btn-view" onclick="viewJobDetails('${job._id}')">
                                <i class="bi bi-eye"></i> View Details
                            </button>
                            <button class="btn-apply" onclick="openApplyModal('${job._id}')" id="applyBtn-${job._id}">
                                <i class="bi bi-check-circle"></i> Apply
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = jobsHTML;
            
            // Hide apply buttons if user is not a student
            if (!isStudentUser()) {
                document.querySelectorAll('[id^="applyBtn-"]').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }

        // View full job details in modal
        async function viewJobDetails(jobId) {
            try {
                const response = await fetch(`/jobs/${jobId}`);
                const job = await response.json();

                currentJobId = jobId;

                // Populate modal
                document.getElementById('jobTitle').textContent = job.title;
                document.getElementById('jobDetailsContent').innerHTML = `
                    <div class="job-details">
                        <h6><i class="bi bi-geo-alt"></i> Location: ${job.location}</h6>
                        <h6><i class="bi bi-briefcase"></i> Job Type: ${job.jobType}</h6>
                        <h6><i class="bi bi-cash"></i> Salary: ${job.salary || 'Not specified'}</h6>
                        
                        <h5 class="mt-3">About this job</h5>
                        <p>${job.description}</p>
                        
                        <h5>Required Skills</h5>
                        <div class="mb-3">
                            ${job.skills.map(skill => `<span class="badge bg-primary me-2">${skill}</span>`).join('')}
                        </div>
                        
                        <h5>Job Type</h5>
                        <p>${job.jobType}</p>
                        
                        <small class="text-muted">Applications: ${job.applicationCount || 0} | Posted on ${new Date(job.createdAt).toLocaleDateString()}</small>
                    </div>
                `;

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading job details:', error);
                alert('Failed to load job details. Please try again.');
            }
        }

        // Open apply modal
        function openApplyModal(jobId) {
            try {
                <% if (!locals.user) { %>
                    alert('Please login to apply for jobs');
                    window.location.href = '/user/signin';
                    return;
                <% } %>

                <% if (locals.user && locals.user.role !== 'student') { %>
                    alert('Only students can apply for jobs');
                    return;
                <% } %>

                // Get job title
                const jobTitle = document.querySelector(`[onclick*="${jobId}"]`)?.closest('.job-card')?.querySelector('.card-title')?.textContent || 'Job';
                
                currentJobId = jobId;
                document.getElementById('applyJobTitle').textContent = jobTitle;
                
                // Set form action
                document.getElementById('applyForm').action = `/applications/${jobId}/apply`;
                
                // Reset form
                document.getElementById('applyForm').reset();

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('applyModal'));
                modal.show();

            } catch (error) {
                console.error('Error opening apply modal:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Handle apply form submission with validation
        document.getElementById('applyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const resumeUrl = document.getElementById('resumeUrl').value.trim();
            
            if (!resumeUrl) {
                alert('Please enter a resume URL');
                return;
            }
            
            if (!resumeUrl.startsWith('http')) {
                alert('Please enter a valid URL (starting with http:// or https://)');
                return;
            }
            
            // Submit the form
            this.submit();
        });

        // Display pagination buttons
        function displayPagination(pagination) {
            const container = document.getElementById('pagination');
            
            if (!pagination || pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // Previous button
            paginationHTML += `
                <li class="page-item ${!pagination.hasPrevPage ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= pagination.totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            // Next button
            paginationHTML += `
                <li class="page-item ${!pagination.hasNextPage ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
                </li>
            `;

            container.innerHTML = paginationHTML;
        }

        // Change page function
        function changePage(page) {
            currentPage = page;
            loadJobs();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
